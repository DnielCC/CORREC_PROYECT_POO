{% extends "reclutador/base.html" %}

{% block title %}Postulaciones Recibidas - Reclutador{% endblock %}

{% block page_title %}Postulaciones Recibidas{% endblock %}

{% block content %}
<!-- Sistema de notificaciones -->
<div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999; display: none;">
    <div id="notification" class="notification" style="padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 400px;">
        <span id="notification-message"></span>
    </div>
</div>

<!-- Header Stats -->
<div class="stats-grid" style="margin-bottom: 2rem;">
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-number">{{ total_postulaciones }}</div>
                <div class="stat-label">Total de Postulaciones</div>
            </div>
            <div class="stat-icon blue">
                <i class="fas fa-users"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-number">{{ en_revision }}</div>
                <div class="stat-label">En Revisión</div>
            </div>
            <div class="stat-icon orange">
                <i class="fas fa-clock"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-number"> {{aceptadas}} </div>
                <div class="stat-label">Aceptadas</div>
            </div>
            <div class="stat-icon green">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-header">
            <div>
                <div class="stat-number">{{rechazadas}}</div>
                <div class="stat-label">Rechazadas</div>
            </div>
            <div class="stat-icon purple">
                <i class="fas fa-times-circle"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label class="form-label">Buscar Candidato</label>
                    <input type="text" id="searchInput" class="form-input" placeholder="Nombre, email o vacante..." onkeyup="filtrarPostulaciones()">
                </div>
                <div style="min-width: 150px;">
                    <label class="form-label">Estado</label>
                    <select id="estadoFilter" class="form-select" onchange="filtrarPostulaciones()">
                        <option value="">Todos</option>
                        <option value="En Revisión">En Revisión</option>
                        <option value="Aceptado">Aceptadas</option>
                        <option value="Rechazado">Rechazadas</option>
                    </select>
                </div>
                <div style="min-width: 150px;">
                    <label class="form-label">Fecha</label>
                    <select id="fechaFilter" class="form-select" onchange="filtrarPostulaciones()">
                        <option value="">Todas las fechas</option>
                        <option value="today">Hoy</option>
                        <option value="week">Esta semana</option>
                        <option value="month">Este mes</option>
                    </select>
                </div>
                <div style="display: flex; align-items: end;">
                    <button class="btn btn-secondary" style="height: 42px;" onclick="limpiarFiltros()">
                        <i class="fas fa-times"></i>
                        Limpiar
                    </button>
                </div>
            </div>
    </div>
</div>

<!-- Applications Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">Lista de Postulaciones</h3>
    </div>
    
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Candidato</th>
                    <th>Vacante</th>
                    <th>Fecha de Postulación</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for p in postulaciones %}
                <tr>
                    <td>
                        <div style="font-weight: 600; color: #1F2937;">{{ p[0] }} {{ p[1] }}</div>
                        <div style="font-size: 0.85em; color: #888;">{{ p[2] }}</div>
                    </td>
                    <td>
                        <div style="font-weight: 600; color: #1F2937;">{{ p[6] }}</div>
                        <div style="font-size: 0.85em; color: #888;">{{ p[7] }}</div>
                    </td>
                    <td>{{ p[8] }}</td>
                    <td>
                        <span class="badge {% if p[9] == 'Aceptado' %}badge-success{% elif p[9] == 'Rechazado' %}badge-danger{% elif p[9] == 'En Revisión' %}badge-warning{% else %}badge-secondary{% endif %}">
                            {{ p[9] }}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <a href="{{ url_for('reclutador_candidato', id=p[4]) }}" class="btn btn-secondary btn-sm" data-tooltip="Ver Perfil">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="btn btn-primary btn-sm" onclick="cambiarEstadoPostulacion('{{ p[10] }}', 'Aceptado')" data-tooltip="Aceptar">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="cambiarEstadoPostulacion('{{ p[10] }}', 'Rechazado')" data-tooltip="Rechazar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                
                {% if not postulaciones %}
                <tr>
                    <td colspan="5" style="text-align:center; color:#888;">No hay postulaciones registradas.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="card-footer">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div style="color: #6B7280; font-size: 0.875rem;">
                Mostrando 1-5 de {{ total_postulaciones }} postulaciones
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-secondary btn-sm">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="btn btn-primary btn-sm">1</button>
                <button class="btn btn-secondary btn-sm">2</button>
                <button class="btn btn-secondary btn-sm">3</button>
                <button class="btn btn-secondary btn-sm">...</button>
                <button class="btn btn-secondary btn-sm">32</button>
                <button class="btn btn-secondary btn-sm">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.badge {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    border-radius: 0.375rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
}

.badge-success {
    background-color: #10B981;
    color: white;
}

.badge-warning {
    background-color: #F59E0B;
    color: white;
}

.badge-danger {
    background-color: #EF4444;
    color: white;
}

.badge-secondary {
    background-color: #6B7280;
    color: white;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    border-radius: 0.25rem;
}

.table-container {
    overflow-x: auto;
}

.table th {
    background-color: #F9FAFB;
    font-weight: 600;
    color: #374151;
    padding: 0.75rem;
    border-bottom: 1px solid #E5E7EB;
}

.table td {
    padding: 0.75rem;
    border-bottom: 1px solid #F3F4F6;
    vertical-align: middle;
}

.table tbody tr:hover {
    background-color: #F9FAFB;
}

/* Estilos para las notificaciones */
.notification {
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* Mejorar la visualización de estados */
.badge-success {
    background: linear-gradient(135deg, #10B981, #34D399);
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    font-weight: 600;
}

.badge-danger {
    background: linear-gradient(135deg, #EF4444, #F87171);
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    font-weight: 600;
}

.badge-warning {
    background: linear-gradient(135deg, #F59E0B, #FBBF24);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    font-weight: 600;
}

.badge-secondary {
    background: linear-gradient(135deg, #6B7280, #9CA3AF);
    box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
    font-weight: 600;
}
</style>

<script>
function cambiarEstadoPostulacion(idPostulacion, nuevoEstado) {
    if (confirm(`¿Estás seguro de que quieres cambiar el estado a "${nuevoEstado}"?`)) {
        // Mapear el estado a los IDs de la base de datos
        let nuevoEstadoId;
        if (nuevoEstado === 'Aceptado') {
            nuevoEstadoId = 5; // ID para Aceptado
        } else if (nuevoEstado === 'Rechazado') {
            nuevoEstadoId = 6; // ID para Rechazado
        } else {
            nuevoEstadoId = 4; // ID para En Revisión
        }
        
        fetch(`/reclutador/postulaciones/${idPostulacion}/cambiar-estado`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                nuevo_estado: nuevoEstadoId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar notificación de éxito
                showNotification(data.message, 'success');
                // Recargar la página después de un breve delay
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showNotification('Error al cambiar el estado: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error al cambiar el estado', 'error');
        });
    }
}

// Función para mostrar notificaciones
function showNotification(message, type) {
    // Crear elemento de notificación
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
        color: white;
        font-weight: 500;
        z-index: 1000;
        max-width: 300px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    `;
    
    if (type === 'success') {
        notification.style.backgroundColor = '#10B981';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#EF4444';
    } else {
        notification.style.backgroundColor = '#6B7280';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Remover notificación después de 3 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 3000);
}

function filtrarPostulaciones() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const estadoFilter = document.getElementById('estadoFilter').value;
    const fechaFilter = document.getElementById('fechaFilter').value;
    
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        if (row.cells.length < 5) return; // Skip header rows
        
        const candidato = row.cells[0].textContent.toLowerCase();
        const vacante = row.cells[1].textContent.toLowerCase();
        const fecha = row.cells[2].textContent;
        const estado = row.cells[3].textContent.trim();
        
        let showRow = true;
        
        // Filtro de búsqueda
        if (searchTerm && !candidato.includes(searchTerm) && !vacante.includes(searchTerm)) {
            showRow = false;
        }
        
        // Filtro de estado
        if (estadoFilter && estado !== estadoFilter) {
            showRow = false;
        }
        
        // Filtro de fecha
        if (fechaFilter && fecha) {
            const fechaPostulacion = new Date(fecha);
            const hoy = new Date();
            
            switch(fechaFilter) {
                case 'today':
                    if (fechaPostulacion.toDateString() !== hoy.toDateString()) {
                        showRow = false;
                    }
                    break;
                case 'week':
                    const unaSemanaAtras = new Date(hoy.getTime() - 7 * 24 * 60 * 60 * 1000);
                    if (fechaPostulacion < unaSemanaAtras) {
                        showRow = false;
                    }
                    break;
                case 'month':
                    const unMesAtras = new Date(hoy.getTime() - 30 * 24 * 60 * 60 * 1000);
                    if (fechaPostulacion < unMesAtras) {
                        showRow = false;
                    }
                    break;
            }
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

function limpiarFiltros() {
    document.getElementById('searchInput').value = '';
    document.getElementById('estadoFilter').value = '';
    document.getElementById('fechaFilter').value = '';
    
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
}
</script>

{% endblock %}
