{% extends "reclutador/base.html" %}

{% block title %}Perfil del Candidato - Reclutador{% endblock %}

{% block page_title %}Perfil del Candidato{% endblock %}

{% block content %}
<!-- Header with Actions -->
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h2 style="font-size: 1.5rem; font-weight: 600; color: #1F2937; margin-bottom: 0.5rem;">{{ candidato.nombre }} {{ candidato.apellidos }}</h2>
        <p style="color: #6B7280; margin: 0;">
            {% if candidato.empleo_deseado %}{{ candidato.empleo_deseado }}{% else %}Sin empleo especificado{% endif %}
            {% if candidato.experiencia %} • {{ candidato.experiencia }}{% endif %}
        </p>
    </div>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('reclutador_postulaciones') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Volver a Postulaciones
        </a>
    </div>
</div>

<!-- Candidate Profile Grid -->
<div class="grid grid-cols-3" style="gap: 2rem;">
    <!-- Main Profile Card -->
    <div class="card" style="grid-column: span 2;">
        <div class="card-header">
            <h3 class="card-title">Información Personal y Profesional</h3>
            <span class="badge badge-warning" id="estado-badge">En Revisión</span>
        </div>
        
        <div class="card-body">
            <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #3B82F6, #1E40AF); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                    <i class="fas fa-user"></i>
                </div>
                <div style="flex: 1;">
                    <h3 style="font-size: 1.5rem; font-weight: 700; color: #1F2937; margin-bottom: 0.5rem;">{{ candidato.nombre }} {{ candidato.apellidos }}</h3>
                    <p style="color: #6B7280; margin-bottom: 0.5rem;">
                        {% if candidato.empleo_deseado %}{{ candidato.empleo_deseado }}{% else %}Sin empleo especificado{% endif %}
                    </p>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        {% if candidato.experiencia %}
                        <span class="badge badge-info">{{ candidato.experiencia }}</span>
                        {% endif %}
                        {% if candidato.ciudad %}
                        <span class="badge badge-info">{{ candidato.ciudad }}{% if candidato.codigo_postal %}, {{ candidato.codigo_postal }}{% endif %}</span>
                        {% endif %}
                        {% if candidato.grado_estudios %}
                        <span class="badge badge-info">{{ candidato.grado_estudios }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="grid grid-cols-2" style="gap: 1.5rem;">
                <div>
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: #1F2937; margin-bottom: 1rem;">
                        <i class="fas fa-envelope" style="color: #3B82F6; margin-right: 0.5rem;"></i>
                        Información de Contacto
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <div style="font-weight: 600; color: #374151;">Email</div>
                            <div style="color: #6B7280;">{{ candidato.email }}</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151;">Teléfono</div>
                            <div style="color: #6B7280;">No disponible</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151;">LinkedIn</div>
                            <div style="color: #6B7280;">No disponible</div>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: #374151;">Portfolio</div>
                            <div style="color: #6B7280;">No disponible</div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <h4 style="font-size: 1.125rem; font-weight: 600; color: #1F2937; margin-bottom: 1rem;">
                        <i class="fas fa-graduation-cap" style="color: #10B981; margin-right: 0.5rem;"></i>
                        Educación y Experiencia
                    </h4>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        {% if candidato.grado_estudios %}
                        <div>
                            <div style="font-weight: 600; color: #374151;">Grado de Estudios</div>
                            <div style="color: #6B7280;">{{ candidato.grado_estudios }}</div>
                        </div>
                        {% endif %}
                        {% if candidato.experiencia %}
                        <div>
                            <div style="font-weight: 600; color: #374151;">Experiencia Laboral</div>
                            <div style="color: #6B7280;">{{ candidato.experiencia }}</div>
                        </div>
                        {% endif %}
                        {% if candidato.empleo_deseado %}
                        <div>
                            <div style="font-weight: 600; color: #374151;">Empleo Deseado</div>
                            <div style="color: #6B7280;">{{ candidato.empleo_deseado }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Stats Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Evaluación</h3>
        </div>
        
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #374151;">Puntuación General</span>
                        <span style="font-weight: 700; color: #10B981; font-size: 1.25rem;">85%</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #E5E7EB; border-radius: 4px; overflow: hidden;">
                        <div style="width: 85%; height: 100%; background: linear-gradient(90deg, #10B981, #059669);"></div>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #374151;">Experiencia</span>
                        <span style="font-weight: 600; color: #3B82F6;">90%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                        <div style="width: 90%; height: 100%; background: #3B82F6;"></div>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #374151;">Habilidades</span>
                        <span style="font-weight: 600; color: #F59E0B;">80%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                        <div style="width: 80%; height: 100%; background: #F59E0B;"></div>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #374151;">Cultura</span>
                        <span style="font-weight: 600; color: #8B5CF6;">75%</span>
                    </div>
                    <div style="width: 100%; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                        <div style="width: 75%; height: 100%; background: #8B5CF6;"></div>
                    </div>
                </div>
                
                <div style="padding-top: 1rem; border-top: 1px solid #E5E7EB;">
                    <div style="text-align: center;">
                        <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Recomendación</div>
                        <span class="badge badge-success">Altamente Recomendado</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location and Additional Info -->
<div class="grid grid-cols-2" style="gap: 2rem; margin-top: 2rem;">
    <!-- Location Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-map-marker-alt" style="color: #EF4444; margin-right: 0.5rem;"></i>
                Información de Ubicación
            </h3>
        </div>
        
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% if candidato.ciudad %}
                <div>
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Ciudad de Residencia</div>
                    <div style="color: #6B7280;">{{ candidato.ciudad }}</div>
                </div>
                {% endif %}
                {% if candidato.codigo_postal %}
                <div>
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Código Postal</div>
                    <div style="color: #6B7280;">{{ candidato.codigo_postal }}</div>
                </div>
                {% endif %}
                {% if not candidato.ciudad and not candidato.codigo_postal %}
                <div style="text-align: center; color: #6B7280; padding: 2rem;">
                    <i class="fas fa-map-marker-alt" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    <p>No hay información de ubicación disponible</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Professional Summary Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-briefcase" style="color: #10B981; margin-right: 0.5rem;"></i>
                Resumen Profesional
            </h3>
        </div>
        
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                {% if candidato.empleo_deseado %}
                <div>
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Posición Deseada</div>
                    <div style="color: #6B7280;">{{ candidato.empleo_deseado }}</div>
                </div>
                {% endif %}
                {% if candidato.experiencia %}
                <div>
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Nivel de Experiencia</div>
                    <div style="color: #6B7280;">{{ candidato.experiencia }}</div>
                </div>
                {% endif %}
                {% if candidato.grado_estudios %}
                <div>
                    <div style="font-weight: 600; color: #374151; margin-bottom: 0.5rem;">Formación Académica</div>
                    <div style="color: #6B7280;">{{ candidato.grado_estudios }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Applications -->
{% if candidato.postulaciones %}
<div style="margin-top: 2rem;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-file-alt" style="color: #8B5CF6; margin-right: 0.5rem;"></i>
                Postulaciones Recientes
            </h3>
        </div>
        
        <div class="card-body">
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid #E5E7EB;">
                            <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Vacante</th>
                            <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Fecha de Postulación</th>
                            <th style="text-align: left; padding: 0.75rem; font-weight: 600; color: #374151;">Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in candidato.postulaciones %}
                        <tr style="border-bottom: 1px solid #F3F4F6;">
                            <td style="padding: 0.75rem; color: #1F2937;">{{ p[0] }}</td>
                            <td style="padding: 0.75rem; color: #6B7280;">{{ p[1].strftime('%d/%m/%Y %H:%M') if p[1] else 'N/A' }}</td>
                            <td style="padding: 0.75rem;">
                                <span class="badge {% if p[2] == 'Aceptado' %}badge-success{% elif p[2] == 'Rechazado' %}badge-danger{% elif p[2] == 'En Revisión' %}badge-warning{% else %}badge-secondary{% endif %}" data-postulacion-id="{{ p[3] }}">
                                    {{ p[2] }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Documents and Actions -->
<div class="grid grid-cols-2" style="gap: 2rem; margin-top: 2rem;">
    <!-- Documents Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Documentos</h3>
        </div>
        
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div style="text-align: center; color: #6B7280; padding: 2rem;">
                    <i class="fas fa-file-alt" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                    <p>No hay documentos disponibles en este momento</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Actions Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">Acciones</h3>
        </div>
        
        <div class="card-body">
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <button class="btn btn-primary" onclick="scheduleInterview()">
                    <i class="fas fa-calendar-plus"></i>
                    Programar Entrevista
                </button>
                
                <button class="btn btn-secondary" onclick="sendMessage()">
                    <i class="fas fa-envelope"></i>
                    Enviar Mensaje
                </button>
                
                <button class="btn btn-secondary" onclick="requestDocuments()">
                    <i class="fas fa-file-upload"></i>
                    Solicitar Documentos
                </button>
                
                <button class="btn btn-secondary" onclick="addNotes()">
                    <i class="fas fa-sticky-note"></i>
                    Agregar Notas
                </button>
                
                <button class="btn btn-secondary" onclick="shareProfile()">
                    <i class="fas fa-share"></i>
                    Compartir Perfil
                </button>
                
            
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Detectar la primera postulación del candidato que pertenece a este reclutador
let currentPostulationId = (function() {
    const filas = document.querySelectorAll('table tbody tr');
    for (const tr of filas) {
        const celdas = tr.querySelectorAll('td');
        if (celdas.length >= 3) {
            // El id de postulación está en el dataset si lo agregamos, o lo obtendremos del texto si está renderizado
            const idSpan = tr.querySelector('[data-postulacion-id]');
            if (idSpan) {
                return parseInt(idSpan.getAttribute('data-postulacion-id'), 10);
            }
        }
    }
    return null;
})();

function acceptCandidate() {
    if (!currentPostulationId) {
        showNotification('Error: No se pudo identificar la postulación', 'error');
        return;
    }
    confirmAction('¿Estás seguro de aceptar a este candidato?', () => {
        cambiarEstadoPostulacion(currentPostulationId, 5); // 5 = Aceptado
    });
}

function rejectCandidate() {
    if (!currentPostulationId) {
        showNotification('Error: No se pudo identificar la postulación', 'error');
        return;
    }
    confirmAction('¿Estás seguro de rechazar a este candidato?', () => {
        cambiarEstadoPostulacion(currentPostulationId, 6); // 6 = Rechazado
    });
}

function cambiarEstadoPostulacion(postulacionId, nuevoEstado) {
    // Realizar la petición AJAX
    fetch(`/reclutador/postulaciones/${postulacionId}/cambiar-estado`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            nuevo_estado: nuevoEstado
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Actualizar el badge de estado
            const badge = document.getElementById('estado-badge');
            if (badge) {
                if (nuevoEstado === 5) { // Aceptado
                    badge.className = 'badge badge-success';
                    badge.textContent = 'Aceptado';
                } else if (nuevoEstado === 6) { // Rechazado
                    badge.className = 'badge badge-danger';
                    badge.textContent = 'Rechazado';
                }
            }
            
            // Actualizar el selector de estado
            const selectEstado = document.querySelector('select[onchange="updateStatus(this.value)"]');
            if (selectEstado) {
                if (nuevoEstado === 5) {
                    selectEstado.value = 'accepted';
                } else if (nuevoEstado === 6) {
                    selectEstado.value = 'rejected';
                }
            }
            
            // Deshabilitar botones de acción
            const btnAceptar = document.getElementById('btn-aceptar');
            const btnRechazar = document.getElementById('btn-rechazar');
            if (btnAceptar) btnAceptar.disabled = true;
            if (btnRechazar) btnRechazar.disabled = true;
            
            // Recargar la página después de 2 segundos para mostrar los cambios
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } else {
            showNotification(`Error: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al cambiar el estado', 'error');
    });
}

function scheduleInterview() {
    showNotification('Entrevista programada para el 25 de Noviembre', 'success');
}

function sendMessage() {
    showNotification('Mensaje enviado al candidato', 'success');
}

function requestDocuments() {
    showNotification('Solicitud de documentos enviada', 'success');
}

function addNotes() {
    showNotification('Notas guardadas', 'success');
}

function shareProfile() {
    showNotification('Enlace del perfil copiado al portapapeles', 'success');
}

function updateStatus(status) {
    const statusMap = {
        'review': { class: 'badge-warning', text: 'En Revisión' },
        'interview': { class: 'badge-info', text: 'Entrevista Programada' },
        'accepted': { class: 'badge-success', text: 'Aceptado' },
        'rejected': { class: 'badge-danger', text: 'Rechazado' },
        'hired': { class: 'badge-success', text: 'Contratado' }
    };
    
    const badge = document.querySelector('.badge');
    badge.className = `badge ${statusMap[status].class}`;
    badge.textContent = statusMap[status].text;
    
    showNotification(`Estado actualizado a: ${statusMap[status].text}`, 'success');
}
</script>
{% endblock %} 