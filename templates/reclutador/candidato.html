{% extends "reclutador/base.html" %}

{% block title %}Perfil del Candidato - Reclutador{% endblock %}

{% block page_title %}Perfil del Candidato{% endblock %}

{% block content %}
<!-- Header with Actions -->
<div class="candidate-header">
    <div class="candidate-info">
        <h2 class="candidate-name">{{ candidato.nombre }} {{ candidato.apellidos }}</h2>
        <p class="candidate-title">
            {% if candidato.empleo_deseado %}
                {{ candidato.empleo_deseado }}
            {% else %}
                Sin empleo especificado
            {% endif %}
            {% if candidato.experiencia %}
                • {{ candidato.experiencia }}
            {% endif %}
        </p>
    </div>
    <div class="header-actions">
        <a href="{{ url_for('reclutador_postulaciones') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i>
            Volver a Postulaciones
        </a>
    </div>
</div>

<!-- Candidate Profile Grid -->
<div class="candidate-grid">
    <!-- Main Profile Card -->
    <div class="card main-profile-card">
        <div class="card-header">
            <h3 class="card-title">Información Personal y Profesional</h3>
            <span class="badge badge-warning" id="estado-badge">En Revisión</span>
        </div>
        
        <div class="card-body">
            <div class="profile-avatar-section">
                <div class="avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-details">
                    <h3 class="profile-name">{{ candidato.nombre }} {{ candidato.apellidos }}</h3>
                    <p class="profile-job">
                        {% if candidato.empleo_deseado %}
                            {{ candidato.empleo_deseado }}
                        {% else %}
                            Sin empleo especificado
                        {% endif %}
                    </p>
                    <div class="profile-badges">
                        {% if candidato.experiencia %}
                            <span class="badge badge-info">{{ candidato.experiencia }}</span>
                        {% endif %}
                        {% if candidato.ciudad %}
                            <span class="badge badge-info">
                                {{ candidato.ciudad }}
                                {% if candidato.codigo_postal %}, {{ candidato.codigo_postal }}{% endif %}
                            </span>
                        {% endif %}
                        {% if candidato.grado_estudios %}
                            <span class="badge badge-info">{{ candidato.grado_estudios }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="profile-sections">
                <div class="contact-section">
                    <h4 class="section-title">
                        <i class="fas fa-envelope icon-blue"></i>
                        Información de Contacto
                    </h4>
                    <div class="contact-details">
                        <div class="contact-item">
                            <div class="contact-label">Email</div>
                            <div class="contact-value">{{ candidato.email }}</div>
                        </div>
                        <div class="contact-item">
                            <div class="contact-label">Teléfono</div>
                            <div class="contact-value">No disponible</div>
                        </div>
                      
                    </div>
                </div>
                
                <div class="education-section">
                    <h4 class="section-title">
                        <i class="fas fa-graduation-cap icon-green"></i>
                        Educación y Experiencia
                    </h4>
                    <div class="education-details">
                        {% if candidato.grado_estudios %}
                            <div class="education-item">
                                <div class="education-label">Grado de Estudios</div>
                                <div class="education-value">{{ candidato.grado_estudios }}</div>
                            </div>
                        {% endif %}
                        {% if candidato.experiencia %}
                            <div class="education-item">
                                <div class="education-label">Experiencia Laboral</div>
                                <div class="education-value">{{ candidato.experiencia }}</div>
                            </div>
                        {% endif %}
                        {% if candidato.empleo_deseado %}
                            <div class="education-item">
                                <div class="education-label">Empleo Deseado</div>
                                <div class="education-value">{{ candidato.empleo_deseado }}</div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Location and Additional Info -->
<div class="info-grid">
    <!-- Location Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-map-marker-alt icon-red"></i>
                Información de Ubicación
            </h3>
        </div>
        
        <div class="card-body">
            <div class="location-details">
                {% if candidato.ciudad %}
                    <div class="location-item">
                        <div class="location-label">Ciudad de Residencia</div>
                        <div class="location-value">{{ candidato.ciudad }}</div>
                    </div>
                {% endif %}
                {% if candidato.codigo_postal %}
                    <div class="location-item">
                        <div class="location-label">Código Postal</div>
                        <div class="location-value">{{ candidato.codigo_postal }}</div>
                    </div>
                {% endif %}
                {% if not candidato.ciudad and not candidato.codigo_postal %}
                    <div class="no-location">
                        <i class="fas fa-map-marker-alt"></i>
                        <p>No hay información de ubicación disponible</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Professional Summary Card -->
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-briefcase icon-green"></i>
                Resumen Profesional
            </h3>
        </div>
        
        <div class="card-body">
            <div class="professional-details">
                {% if candidato.empleo_deseado %}
                    <div class="professional-item">
                        <div class="professional-label">Posición Deseada</div>
                        <div class="professional-value">{{ candidato.empleo_deseado }}</div>
                    </div>
                {% endif %}
                {% if candidato.experiencia %}
                    <div class="professional-item">
                        <div class="professional-label">Nivel de Experiencia</div>
                        <div class="professional-value">{{ candidato.experiencia }}</div>
                    </div>
                {% endif %}
                {% if candidato.grado_estudios %}
                    <div class="professional-item">
                        <div class="professional-label">Formación Académica</div>
                        <div class="professional-value">{{ candidato.grado_estudios }}</div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Recent Applications -->
{% if candidato.postulaciones %}
    <div class="applications-section">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-file-alt icon-purple"></i>
                    Postulaciones Recientes
                </h3>
            </div>
            
            <div class="card-body">
                <div class="table-container">
                    <table class="applications-table">
                        <thead>
                            <tr>
                                <th>Vacante</th>
                                <th>Fecha de Postulación</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in candidato.postulaciones %}
                                <tr>
                                    <td>{{ p[0] }}</td>
                                    <td>
                                        {% if p[1] %}
                                            {{ p[1].strftime('%d/%m/%Y %H:%M') }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if p[2] == 'Aceptado' %}badge-success
                                            {% elif p[2] == 'Rechazado' %}badge-danger
                                            {% elif p[2] == 'En Revisión' %}badge-warning
                                            {% else %}badge-secondary{% endif %}"
                                            data-postulacion-id="{{ p[3] }}">
                                            {{ p[2] }}
                                        </span>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Detectar la primera postulación del candidato que pertenece a este reclutador
let currentPostulationId = (function() {
    const filas = document.querySelectorAll('table tbody tr');
    for (const tr of filas) {
        const celdas = tr.querySelectorAll('td');
        if (celdas.length >= 3) {
            const idSpan = tr.querySelector('[data-postulacion-id]');
            if (idSpan) {
                return parseInt(idSpan.getAttribute('data-postulacion-id'), 10);
            }
        }
    }
    return null;
})();

function acceptCandidate() {
    if (!currentPostulationId) {
        showNotification('Error: No se pudo identificar la postulación', 'error');
        return;
    }
    confirmAction('¿Estás seguro de aceptar a este candidato?', () => {
        cambiarEstadoPostulacion(currentPostulationId, 5); // 5 = Aceptado
    });
}

function rejectCandidate() {
    if (!currentPostulationId) {
        showNotification('Error: No se pudo identificar la postulación', 'error');
        return;
    }
    confirmAction('¿Estás seguro de rechazar a este candidato?', () => {
        cambiarEstadoPostulacion(currentPostulationId, 6); // 6 = Rechazado
    });
}

function cambiarEstadoPostulacion(postulacionId, nuevoEstado) {
    fetch(`/reclutador/postulaciones/${postulacionId}/cambiar-estado`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            nuevo_estado: nuevoEstado
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            
            // Actualizar el badge de estado
            const badge = document.getElementById('estado-badge');
            if (badge) {
                if (nuevoEstado === 5) { // Aceptado
                    badge.className = 'badge badge-success';
                    badge.textContent = 'Aceptado';
                } else if (nuevoEstado === 6) { // Rechazado
                    badge.className = 'badge badge-danger';
                    badge.textContent = 'Rechazado';
                }
            }
            
            // Actualizar el selector de estado
            const selectEstado = document.querySelector('select[onchange="updateStatus(this.value)"]');
            if (selectEstado) {
                if (nuevoEstado === 5) {
                    selectEstado.value = 'accepted';
                } else if (nuevoEstado === 6) {
                    selectEstado.value = 'rejected';
                }
            }
            
            // Deshabilitar botones de acción
            const btnAceptar = document.getElementById('btn-aceptar');
            const btnRechazar = document.getElementById('btn-rechazar');
            if (btnAceptar) btnAceptar.disabled = true;
            if (btnRechazar) btnRechazar.disabled = true;
            
            // Recargar la página después de 2 segundos para mostrar los cambios
            setTimeout(() => {
                window.location.reload();
            }, 2000);
            
        } else {
            showNotification(`Error: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error al cambiar el estado', 'error');
    });
}

function scheduleInterview() {
    showNotification('Entrevista programada para el 25 de Noviembre', 'success');
}

function sendMessage() {
    showNotification('Mensaje enviado al candidato', 'success');
}

function requestDocuments() {
    showNotification('Solicitud de documentos enviada', 'success');
}

function addNotes() {
    showNotification('Notas guardadas', 'success');
}

function shareProfile() {
    showNotification('Enlace del perfil copiado al portapapeles', 'success');
}

function updateStatus(status) {
    const statusMap = {
        'review': { class: 'badge-warning', text: 'En Revisión' },
        'interview': { class: 'badge-info', text: 'Entrevista Programada' },
        'accepted': { class: 'badge-success', text: 'Aceptado' },
        'rejected': { class: 'badge-danger', text: 'Rechazado' },
        'hired': { class: 'badge-success', text: 'Contratado' }
    };
    
    const badge = document.querySelector('.badge');
    badge.className = `badge ${statusMap[status].class}`;
    badge.textContent = statusMap[status].text;
    
    showNotification(`Estado actualizado a: ${statusMap[status].text}`, 'success');
}
</script>
{% endblock %} 